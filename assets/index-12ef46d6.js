const Z=(s,t=e=>e!==void 0?": "+e:"")=>class extends Error{constructor(e){super(s(e)+t(e))}},V=Z(()=>"illegal argument(s)"),G=s=>{throw new V(s)},Y=Z(()=>"illegal state"),z=s=>{throw new Y(s)},tt=Math.pow(2,32);class W{constructor(t,e=0,i=t.length<<3){this.buffer=t,this.start=e,this.limit=i,this.seek(e)}*[Symbol.iterator](){let t=this.start,e=t>>>3,i=7-(t&7);for(;t<this.limit;)yield this.buffer[e]>>>i&1,--i<0&&(e++,i=7),t++}get length(){return this.limit}get position(){return this.bitPos}seek(t){return(t<this.start||t>=this.limit)&&G(`seek pos out of bounds: ${t}`),this.pos=t>>>3,this.bit=8-(t&7),this.bitPos=t,this}read(t=1){if(t>32)return this.read(t-32)*tt+this.read(32);if(t>8){let e=0,i=t&-8,n=t-i;for(n>0&&(e=this._read(n));i>0;)e=(e<<8|this._read(8))>>>0,i-=8;return e}else return this._read(t)}readFields(t){return t.map(e=>this.read(e))}readWords(t,e=8){let i=[];for(;t-- >0;)i.push(this.read(e));return i}readStruct(t){return t.reduce((e,[i,n])=>(e[i]=this.read(n),e),{})}readBit(){this.checkLimit(1),this.bit--,this.bitPos++;let t=this.buffer[this.pos]>>>this.bit&1;return this.bit===0&&(this.pos++,this.bit=8),t}_read(t){this.checkLimit(t);let e=this.bit-t,i;return e>=0?(this.bit=e,i=this.buffer[this.pos]>>>e&(1<<t)-1,e===0&&(this.pos++,this.bit=8)):(i=(this.buffer[this.pos++]&(1<<this.bit)-1)<<-e,this.bit=8+e,i=i|this.buffer[this.pos]>>>this.bit),this.bitPos+=t,i}checkLimit(t){this.bitPos+t>this.limit&&z("can't read past EOF")}}const et=16,C=Math.pow(2,32);class st{constructor(t,e=0){this.buffer=typeof t>"u"?new Uint8Array(et):typeof t=="number"?new Uint8Array(t):t,this.start=e,this.seek(e),this.buffer[this.pos]&=~((1<<this.bit)-1)}get position(){return this.bitPos}seek(t){return(t<this.start||t>=this.buffer.length<<3)&&G(`seek pos out of bounds: ${t}`),this.pos=t>>>3,this.bit=8-(t&7),this.bitPos=t,this}bytes(){return this.buffer.slice(0,this.pos+(this.bit&7?1:0))}reader(t=0){return new W(this.buffer,t,this.position)}write(t,e=1){if(e>32){let i=Math.floor(t/C);this.write(i,e-32),this.write(t-i*C,32)}else if(e>8){let i=e&-8,n=e-i;for(n>0&&this._write(t>>>i,n),i-=8;i>=0;)this._write(t>>>i,8),i-=8}else this._write(t,e);return this}writeWords(t,e=8){let i=t[Symbol.iterator](),n;for(;n=i.next(),!n.done;)this.write(n.value,e)}writeBit(t){return this.bit--,this.buffer[this.pos]=this.buffer[this.pos]&~(1<<this.bit)|t<<this.bit,this.bit===0&&(this.ensureSize(),this.bit=8),this.bitPos++,this}_write(t,e){t&=(1<<e)-1;let i=this.buffer,n=this.pos,r=this.bit,a=r-e,c=r<8?~((1<<r)-1):0;return a>=0?(c|=(1<<a)-1,i[n]=i[n]&c|t<<a&~c,a===0?(this.ensureSize(),this.bit=8):this.bit=a):(this.bit=r=8+a,i[n]=i[n]&c|t>>>-a&~c,this.ensureSize(),this.buffer[this.pos]=this.buffer[this.pos]&(1<<r)-1|t<<r&255),this.bitPos+=e,this}ensureSize(){if(++this.pos===this.buffer.length){let t=new Uint8Array(this.buffer.length<<1);t.set(this.buffer),this.buffer=t}}}const T=16,b=20,it=256,F=it*b,E=4,j=1903124838,nt=(s,t)=>Math.floor(8+E*4*s+8*t*s);function q(s,t,e){return s<t?t:s>e?e:s}function N(s,t){const e=new Int16Array(s||4),i=new Int16Array(t||4);return{history:e,weights:i}}function v(s,t){return s[0]*t[0]+s[1]*t[1]+s[2]*t[2]+s[3]*t[3]>>13}function H(s,t,e,i){let n=i>>4;s[0]+=t[0]<0?-n:n,s[1]+=t[1]<0?-n:n,s[2]+=t[2]<0?-n:n,s[3]+=t[3]<0?-n:n,t[0]=t[1],t[1]=t[2],t[2]=t[3],t[3]=e}const X=s=>Math.sign(s)*Math.round(Math.abs(s)),J=Array(16).fill().map((s,t)=>X(Math.pow(t+1,2.75))),rt=[.75,-.75,2.5,-2.5,4.5,-4.5,7,-7],K=J.map(s=>rt.map(t=>X(t*s)));function lt(s){if(s.read(32)!==j)throw new Error("Not a QOA file; expected magic number 'qoaf'");const e={samples:s.read(32),channels:s.read(8),sampleRate:s.read(24)};return s.seek(64),e}function ot(s,t,e,i,n){const r=s.read(8),a=s.read(24),c=s.read(16),w=s.read(16),g=Math.floor(w-8-E*4*r),o=Math.floor(g/8)*b;if(r!=t.channels||a!=t.sampleRate||c*r>o)throw new Error("invalid frame header data");for(let l=0;l<r;l++){const _=e[l];for(let f=0;f<E;f++){let p=s.read(16);_.history[f]=p}for(let f=0;f<E;f++){let p=s.read(16);_.weights[f]=p}}for(let l=0;l<c;l+=b)for(let _=0;_<r;_++){const f=s.read(4),p=K[f],I=l,S=Math.min(l+b,c)-I,u=e[_],m=i[_];let x=n+I;const L=u.weights,A=u.history;let k=60;for(let O=0;O<S;O++){const d=v(L,A),R=s.read(3),y=p[R],M=q(d+y,-32768,32767),Q=M<0?M/32768:M/32767;m[x++]=Q,H(L,A,M,y),k-=3}k>0&&s.read(k)}return c}function ut(s){if(s.byteLength<T)throw new Error(`QOA file size must be >= ${T}`);const t=new W(s),e=lt(t),i=[],n=[];for(let c=0;c<e.channels;c++){const w=new Float32Array(e.samples);i.push(w),n.push(N())}let r=0,a=0;do a=ot(t,e,n,i,r),r+=a;while(a&&r<e.samples);return{...e,channelData:i}}const at=J.map(s=>Math.floor((65536+s-1)/s)),ct=[7,7,7,5,5,3,3,1,0,0,2,2,4,4,6,6,6];function ht(s,t){const e=at[t];let i=s*e+32768>>16;return i=i+((s>0)-(s<0))-((i>0)-(i<0)),i}function ft(s,t,e,i,n){const r=t.channels,a=t.sampleRate,c=t.channelData;t.samples;const w=Math.floor((n+b-1)/b),g=nt(r,w);s.write(r,8),s.write(a,24),s.write(n,16),s.write(g,16);for(let h=0;h<r;h++){const o=e[h];for(let l=0;l<E;l++)s.write(o.history[l],16);for(let l=0;l<E;l++)s.write(o.weights[l],16)}for(let h=0;h<n;h+=b)for(let o=0;o<r;o++){const l=q(b,0,n-h),_=h;let f=Number.MAX_SAFE_INTEGER,p,I,P;const S=c[o];for(let u=0;u<16;u++){let m=N(e[o].history,e[o].weights);const x=K[u];let L=[],A=0,k=_+i;for(let O=0;O<l;O++){let d=S[k++];d=Math.floor(Math.fround(d<0?d*32768:d*32767)),d=q(d,-32768,32767);let R=v(m.weights,m.history),y=d-R,M=ht(y,u),Q=q(M,-8,8),U=ct[Q+8],B=x[U],D=q(R+B,-32768,32767),$=d-D;if(A+=$*$,A>f)break;H(m.weights,m.history,D,B),L.push(U)}A<f&&(f=A,p=L,I=u,P=m)}e[o]=P,s.write(I,4);for(let u=0;u<b;u++){const m=u<p.length?p[u]:0;s.write(m,3)}}}function bt({channelData:s,sampleRate:t=44100}={}){const e=s.length,i=e>=1?s[0].length:0,n={samples:i,channels:e,channelData:s,sampleRate:t},r=(i+F-1)/F,a=(i+b-1)/b,c=8+r*8+r*E*4*n.channels+a*8*n.channels,w=[];for(let o=0;o<n.channels;o++){const l=N();l.weights[0]=0,l.weights[1]=0,l.weights[2]=-8192,l.weights[3]=16384,w.push(l)}const g=new st(c);g.write(j,32),g.write(i,32);let h=F;for(let o=0;o<i;o+=h)h=q(F,0,i-o),ft(g,n,w,o,h);return g.bytes()}export{ut as decode,bt as encode};
