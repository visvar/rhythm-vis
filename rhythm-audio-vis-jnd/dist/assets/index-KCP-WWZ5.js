const Z=(s,t=e=>e!==void 0?": "+e:"")=>class extends Error{constructor(e){super(s(e)+t(e))}},V=Z(()=>"illegal argument(s)"),G=s=>{throw new V(s)},Y=Z(()=>"illegal state"),z=s=>{throw new Y(s)},tt=Math.pow(2,32);class W{constructor(t,e=0,i=t.length<<3){this.buffer=t,this.start=e,this.limit=i,this.seek(e)}*[Symbol.iterator](){let t=this.start,e=t>>>3,i=7-(t&7);for(;t<this.limit;)yield this.buffer[e]>>>i&1,--i<0&&(e++,i=7),t++}get length(){return this.limit}get position(){return this.bitPos}seek(t){return(t<this.start||t>=this.limit)&&G(`seek pos out of bounds: ${t}`),this.pos=t>>>3,this.bit=8-(t&7),this.bitPos=t,this}read(t=1){if(t>32)return this.read(t-32)*tt+this.read(32);if(t>8){let e=0,i=t&-8,n=t-i;for(n>0&&(e=this._read(n));i>0;)e=(e<<8|this._read(8))>>>0,i-=8;return e}else return this._read(t)}readFields(t){return t.map(e=>this.read(e))}readWords(t,e=8){let i=[];for(;t-- >0;)i.push(this.read(e));return i}readStruct(t){return t.reduce((e,[i,n])=>(e[i]=this.read(n),e),{})}readBit(){this.checkLimit(1),this.bit--,this.bitPos++;let t=this.buffer[this.pos]>>>this.bit&1;return this.bit===0&&(this.pos++,this.bit=8),t}_read(t){this.checkLimit(t);let e=this.bit-t,i;return e>=0?(this.bit=e,i=this.buffer[this.pos]>>>e&(1<<t)-1,e===0&&(this.pos++,this.bit=8)):(i=(this.buffer[this.pos++]&(1<<this.bit)-1)<<-e,this.bit=8+e,i=i|this.buffer[this.pos]>>>this.bit),this.bitPos+=t,i}checkLimit(t){this.bitPos+t>this.limit&&z("can't read past EOF")}}const et=16,C=Math.pow(2,32);class st{constructor(t,e=0){this.buffer=typeof t>"u"?new Uint8Array(et):typeof t=="number"?new Uint8Array(t):t,this.start=e,this.seek(e),this.buffer[this.pos]&=~((1<<this.bit)-1)}get position(){return this.bitPos}seek(t){return(t<this.start||t>=this.buffer.length<<3)&&G(`seek pos out of bounds: ${t}`),this.pos=t>>>3,this.bit=8-(t&7),this.bitPos=t,this}bytes(){return this.buffer.slice(0,this.pos+(this.bit&7?1:0))}reader(t=0){return new W(this.buffer,t,this.position)}write(t,e=1){if(e>32){let i=Math.floor(t/C);this.write(i,e-32),this.write(t-i*C,32)}else if(e>8){let i=e&-8,n=e-i;for(n>0&&this._write(t>>>i,n),i-=8;i>=0;)this._write(t>>>i,8),i-=8}else this._write(t,e);return this}writeWords(t,e=8){let i=t[Symbol.iterator](),n;for(;n=i.next(),!n.done;)this.write(n.value,e)}writeBit(t){return this.bit--,this.buffer[this.pos]=this.buffer[this.pos]&~(1<<this.bit)|t<<this.bit,this.bit===0&&(this.ensureSize(),this.bit=8),this.bitPos++,this}_write(t,e){t&=(1<<e)-1;let i=this.buffer,n=this.pos,o=this.bit,l=o-e,h=o<8?~((1<<o)-1):0;return l>=0?(h|=(1<<l)-1,i[n]=i[n]&h|t<<l&~h,l===0?(this.ensureSize(),this.bit=8):this.bit=l):(this.bit=o=8+l,i[n]=i[n]&h|t>>>-l&~h,this.ensureSize(),this.buffer[this.pos]=this.buffer[this.pos]&(1<<o)-1|t<<o&255),this.bitPos+=e,this}ensureSize(){if(++this.pos===this.buffer.length){let t=new Uint8Array(this.buffer.length<<1);t.set(this.buffer),this.buffer=t}}}const T=16,d=20,it=256,y=it*d,E=4,j=1903124838,nt=(s,t)=>Math.floor(8+E*4*s+8*t*s);function q(s,t,e){return s<t?t:s>e?e:s}function N(s,t){const e=new Int16Array(s||4),i=new Int16Array(t||4);return{history:e,weights:i}}function v(s,t){return s[0]*t[0]+s[1]*t[1]+s[2]*t[2]+s[3]*t[3]>>13}function H(s,t,e,i){let n=i>>4;s[0]+=t[0]<0?-n:n,s[1]+=t[1]<0?-n:n,s[2]+=t[2]<0?-n:n,s[3]+=t[3]<0?-n:n,t[0]=t[1],t[1]=t[2],t[2]=t[3],t[3]=e}const X=s=>Math.sign(s)*Math.round(Math.abs(s)),J=Array(16).fill().map((s,t)=>X(Math.pow(t+1,2.75))),rt=[.75,-.75,2.5,-2.5,4.5,-4.5,7,-7],K=J.map(s=>rt.map(t=>X(t*s)));function ot(s){if(s.read(32)!==j)throw new Error("Not a QOA file; expected magic number 'qoaf'");const e={samples:s.read(32),channels:s.read(8),sampleRate:s.read(24)};return s.seek(64),e}function lt(s,t,e,i,n){const o=s.read(8),l=s.read(24),h=s.read(16),m=s.read(16),g=Math.floor(m-8-E*4*o),r=Math.floor(g/8)*d;if(o!=t.channels||l!=t.sampleRate||h*o>r)throw new Error("invalid frame header data");for(let a=0;a<o;a++){const c=e[a];for(let u=0;u<E;u++){let p=s.read(16);c.history[u]=p}for(let u=0;u<E;u++){let p=s.read(16);c.weights[u]=p}}for(let a=0;a<h;a+=d)for(let c=0;c<o;c++){const u=s.read(4),p=K[u],I=a,P=Math.min(a+d,h)-I,b=e[c],w=i[c];let S=n+I;const L=b.weights,A=b.history;let k=60;for(let O=0;O<P;O++){const _=v(L,A),R=s.read(3),x=p[R],M=q(_+x,-32768,32767),Q=M<0?M/32768:M/32767;w[S++]=Q,H(L,A,M,x),k-=3}k>0&&s.read(k)}return h}function ut(s){if(s.byteLength<T)throw new Error(`QOA file size must be >= ${T}`);const t=new W(s),e=ot(t),i=[],n=[];for(let h=0;h<e.channels;h++){const m=new Float32Array(e.samples);i.push(m),n.push(N())}let o=0,l=0;do l=lt(t,e,n,i,o),o+=l;while(l&&o<e.samples);return{...e,channelData:i}}const ht=J.map(s=>Math.floor((65536+s-1)/s)),at=[7,7,7,5,5,3,3,1,0,0,2,2,4,4,6,6,6];function ct(s,t){const e=ht[t];let i=s*e+32768>>16;return i=i+((s>0)-(s<0))-((i>0)-(i<0)),i}function ft(s,t,e,i,n){const o=t.channels,l=t.sampleRate,h=t.channelData;t.samples;const m=Math.floor((n+d-1)/d),g=nt(o,m);s.write(o,8),s.write(l,24),s.write(n,16),s.write(g,16);for(let f=0;f<o;f++){const r=e[f];r.weights[0]*r.weights[0]+r.weights[1]*r.weights[1]+r.weights[2]*r.weights[2]+r.weights[3]*r.weights[3]>805306367&&(r.weights[0]=0,r.weights[1]=0,r.weights[2]=0,r.weights[3]=0);for(let c=0;c<E;c++)s.write(r.history[c],16);for(let c=0;c<E;c++)s.write(r.weights[c],16)}for(let f=0;f<n;f+=d)for(let r=0;r<o;r++){const a=q(d,0,n-f),c=f;let u=Number.MAX_SAFE_INTEGER,p,I,F;const P=h[r];for(let b=0;b<16;b++){let w=N(e[r].history,e[r].weights);const S=K[b];let L=[],A=0,k=c+i;for(let O=0;O<a;O++){let _=P[k++];_=Math.floor(Math.fround(_<0?_*32768:_*32767)),_=q(_,-32768,32767);let R=v(w.weights,w.history),x=_-R,M=ct(x,b),Q=q(M,-8,8),U=at[Q+8],B=S[U],D=q(R+B,-32768,32767),$=_-D;if(A+=$*$,A>u)break;H(w.weights,w.history,D,B),L.push(U)}A<u&&(u=A,p=L,I=b,F=w)}e[r]=F,s.write(I,4);for(let b=0;b<d;b++){const w=b<p.length?p[b]:0;s.write(w,3)}}}function bt({channelData:s,sampleRate:t=44100}={}){const e=s.length,i=e>=1?s[0].length:0,n={samples:i,channels:e,channelData:s,sampleRate:t},o=(i+y-1)/y,l=(i+d-1)/d,h=8+o*8+o*E*4*n.channels+l*8*n.channels,m=[];for(let r=0;r<n.channels;r++){const a=N();a.weights[0]=0,a.weights[1]=0,a.weights[2]=-8192,a.weights[3]=16384,m.push(a)}const g=new st(h);g.write(j,32),g.write(i,32);let f=y;for(let r=0;r<i;r+=f)f=q(y,0,i-r),ft(g,n,m,r,f);return g.bytes()}export{ut as decode,bt as encode};
