var Y=Object.defineProperty;var z=(s,t,e)=>t in s?Y(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e;var d=(s,t,e)=>(z(s,typeof t!="symbol"?t+"":t,e),e);const v=(s,t=e=>e!==void 0?": "+e:"")=>class extends Error{constructor(e){super(s(e)+t(e))}},tt=v(()=>"illegal argument(s)"),G=s=>{throw new tt(s)},et=v(()=>"illegal state"),st=s=>{throw new et(s)},it=Math.pow(2,32);class W{constructor(t,e=0,i=t.length<<3){d(this,"buffer");d(this,"start");d(this,"limit");d(this,"pos");d(this,"bitPos");d(this,"bit");this.buffer=t,this.start=e,this.limit=i,this.seek(e)}*[Symbol.iterator](){let t=this.start,e=t>>>3,i=7-(t&7);for(;t<this.limit;)yield this.buffer[e]>>>i&1,--i<0&&(e++,i=7),t++}get length(){return this.limit}get position(){return this.bitPos}seek(t){return(t<this.start||t>=this.limit)&&G(`seek pos out of bounds: ${t}`),this.pos=t>>>3,this.bit=8-(t&7),this.bitPos=t,this}read(t=1){if(t>32)return this.read(t-32)*it+this.read(32);if(t>8){let e=0,i=t&-8,r=t-i;for(r>0&&(e=this._read(r));i>0;)e=(e<<8|this._read(8))>>>0,i-=8;return e}else return this._read(t)}readFields(t){return t.map(e=>this.read(e))}readWords(t,e=8){let i=[];for(;t-- >0;)i.push(this.read(e));return i}readStruct(t){return t.reduce((e,[i,r])=>(e[i]=this.read(r),e),{})}readBit(){this.checkLimit(1),this.bit--,this.bitPos++;let t=this.buffer[this.pos]>>>this.bit&1;return this.bit===0&&(this.pos++,this.bit=8),t}_read(t){this.checkLimit(t);let e=this.bit-t,i;return e>=0?(this.bit=e,i=this.buffer[this.pos]>>>e&(1<<t)-1,e===0&&(this.pos++,this.bit=8)):(i=(this.buffer[this.pos++]&(1<<this.bit)-1)<<-e,this.bit=8+e,i=i|this.buffer[this.pos]>>>this.bit),this.bitPos+=t,i}checkLimit(t){this.bitPos+t>this.limit&&st("can't read past EOF")}}const rt=16,T=Math.pow(2,32);class nt{constructor(t,e=0){d(this,"buffer");d(this,"start");d(this,"pos");d(this,"bit");d(this,"bitPos");this.buffer=typeof t>"u"?new Uint8Array(rt):typeof t=="number"?new Uint8Array(t):t,this.start=e,this.seek(e),this.buffer[this.pos]&=~((1<<this.bit)-1)}get position(){return this.bitPos}seek(t){return(t<this.start||t>=this.buffer.length<<3)&&G(`seek pos out of bounds: ${t}`),this.pos=t>>>3,this.bit=8-(t&7),this.bitPos=t,this}bytes(){return this.buffer.slice(0,this.pos+(this.bit&7?1:0))}reader(t=0){return new W(this.buffer,t,this.position)}write(t,e=1){if(e>32){let i=Math.floor(t/T);this.write(i,e-32),this.write(t-i*T,32)}else if(e>8){let i=e&-8,r=e-i;for(r>0&&this._write(t>>>i,r),i-=8;i>=0;)this._write(t>>>i,8),i-=8}else this._write(t,e);return this}writeWords(t,e=8){let i=t[Symbol.iterator](),r;for(;r=i.next(),!r.done;)this.write(r.value,e)}writeBit(t){return this.bit--,this.buffer[this.pos]=this.buffer[this.pos]&~(1<<this.bit)|t<<this.bit,this.bit===0&&(this.ensureSize(),this.bit=8),this.bitPos++,this}_write(t,e){t&=(1<<e)-1;let i=this.buffer,r=this.pos,o=this.bit,l=o-e,h=o<8?~((1<<o)-1):0;return l>=0?(h|=(1<<l)-1,i[r]=i[r]&h|t<<l&~h,l===0?(this.ensureSize(),this.bit=8):this.bit=l):(this.bit=o=8+l,i[r]=i[r]&h|t>>>-l&~h,this.ensureSize(),this.buffer[this.pos]=this.buffer[this.pos]&(1<<o)-1|t<<o&255),this.bitPos+=e,this}ensureSize(){if(++this.pos===this.buffer.length){let t=new Uint8Array(this.buffer.length<<1);t.set(this.buffer),this.buffer=t}}}const Z=16,_=20,ot=256,F=ot*_,M=4,j=1903124838,lt=(s,t)=>Math.floor(8+M*4*s+8*t*s);function I(s,t,e){return s<t?t:s>e?e:s}function x(s,t){const e=new Int16Array(s||4),i=new Int16Array(t||4);return{history:e,weights:i}}function H(s,t){return s[0]*t[0]+s[1]*t[1]+s[2]*t[2]+s[3]*t[3]>>13}function X(s,t,e,i){let r=i>>4;s[0]+=t[0]<0?-r:r,s[1]+=t[1]<0?-r:r,s[2]+=t[2]<0?-r:r,s[3]+=t[3]<0?-r:r,t[0]=t[1],t[1]=t[2],t[2]=t[3],t[3]=e}const J=s=>Math.sign(s)*Math.round(Math.abs(s)),K=Array(16).fill().map((s,t)=>J(Math.pow(t+1,2.75))),ht=[.75,-.75,2.5,-2.5,4.5,-4.5,7,-7],V=K.map(s=>ht.map(t=>J(t*s)));function at(s){if(s.read(32)!==j)throw new Error("Not a QOA file; expected magic number 'qoaf'");const e={samples:s.read(32),channels:s.read(8),sampleRate:s.read(24)};return s.seek(64),e}function ct(s,t,e,i,r){const o=s.read(8),l=s.read(24),h=s.read(16),g=s.read(16),A=Math.floor(g-8-M*4*o),n=Math.floor(A/8)*_;if(o!=t.channels||l!=t.sampleRate||h*o>n)throw new Error("invalid frame header data");for(let a=0;a<o;a++){const c=e[a];for(let u=0;u<M;u++){let w=s.read(16);c.history[u]=w}for(let u=0;u<M;u++){let w=s.read(16);c.weights[u]=w}}for(let a=0;a<h;a+=_)for(let c=0;c<o;c++){const u=s.read(4),w=V[u],L=a,Q=Math.min(a+_,h)-L,b=e[c],m=i[c];let N=r+L;const P=b.weights,E=b.history;let k=60;for(let O=0;O<Q;O++){const p=H(P,E),R=s.read(3),y=w[R],q=I(p+y,-32768,32767),U=q<0?q/32768:q/32767;m[N++]=U,X(P,E,q,y),k-=3}k>0&&s.read(k)}return h}function pt(s){if(s.byteLength<Z)throw new Error(`QOA file size must be >= ${Z}`);const t=new W(s),e=at(t),i=[],r=[];for(let h=0;h<e.channels;h++){const g=new Float32Array(e.samples);i.push(g),r.push(x())}let o=0,l=0;do l=ct(t,e,r,i,o),o+=l;while(l&&o<e.samples);return{...e,channelData:i}}const ft=K.map(s=>Math.floor((65536+s-1)/s)),ut=[7,7,7,5,5,3,3,1,0,0,2,2,4,4,6,6,6];function bt(s,t){const e=ft[t];let i=s*e+32768>>16;return i=i+((s>0)-(s<0))-((i>0)-(i<0)),i}function dt(s,t,e,i,r){const o=t.channels,l=t.sampleRate,h=t.channelData;t.samples;const g=Math.floor((r+_-1)/_),A=lt(o,g);s.write(o,8),s.write(l,24),s.write(r,16),s.write(A,16);for(let f=0;f<o;f++){const n=e[f];n.weights[0]*n.weights[0]+n.weights[1]*n.weights[1]+n.weights[2]*n.weights[2]+n.weights[3]*n.weights[3]>805306367&&(n.weights[0]=0,n.weights[1]=0,n.weights[2]=0,n.weights[3]=0);for(let c=0;c<M;c++)s.write(n.history[c],16);for(let c=0;c<M;c++)s.write(n.weights[c],16)}for(let f=0;f<r;f+=_)for(let n=0;n<o;n++){const a=I(_,0,r-f),c=f;let u=Number.MAX_SAFE_INTEGER,w,L,S;const Q=h[n];for(let b=0;b<16;b++){let m=x(e[n].history,e[n].weights);const N=V[b];let P=[],E=0,k=c+i;for(let O=0;O<a;O++){let p=Q[k++];p=Math.floor(Math.fround(p<0?p*32768:p*32767)),p=I(p,-32768,32767);let R=H(m.weights,m.history),y=p-R,q=bt(y,b),U=I(q,-8,8),B=ut[U+8],D=N[B],$=I(R+D,-32768,32767),C=p-$;if(E+=C*C,E>u)break;X(m.weights,m.history,$,D),P.push(B)}E<u&&(u=E,w=P,L=b,S=m)}e[n]=S,s.write(L,4);for(let b=0;b<_;b++){const m=b<w.length?w[b]:0;s.write(m,3)}}}function wt({channelData:s,sampleRate:t=44100}={}){const e=s.length,i=e>=1?s[0].length:0,r={samples:i,channels:e,channelData:s,sampleRate:t},o=(i+F-1)/F,l=(i+_-1)/_,h=8+o*8+o*M*4*r.channels+l*8*r.channels,g=[];for(let n=0;n<r.channels;n++){const a=x();a.weights[0]=0,a.weights[1]=0,a.weights[2]=-8192,a.weights[3]=16384,g.push(a)}const A=new nt(h);A.write(j,32),A.write(i,32);let f=F;for(let n=0;n<i;n+=f)f=I(F,0,i-n),dt(A,r,g,n,f);return A.bytes()}export{pt as decode,wt as encode};
